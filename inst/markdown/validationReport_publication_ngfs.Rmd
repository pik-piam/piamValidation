---
title: "piamValidation publication: NGFS plots"
date: "`r format(Sys.Date())`"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
    always_allow_html: true
  pdf_document:
    toc: true
params:
  mif: ''
  cfg: ''
  extraColors: true
  warning: false
  message: false
  figWidth: 8
---

```{r include=FALSE}
devtools::load_all(".")
library(knitr)
library(dplyr)
library(ggplot2)
library(ggthemes)
library(plotly)

knitr::opts_chunk$set(
  echo = FALSE,
  error = TRUE,
  message = params$message,
  warning = params$warning
)
# ensure that the working directory is the project root
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

# NGFS Scenarios

## Import and Prepare Data

Using scenario data from:
(https://doi.org/10.5281/zenodo.13989530)

```{r}
cat("V5.0-NGFS-Phase-5/IAM_data.xlsx\n")
```

Using config:

```{r}
cat("validationConfig_publication_NGFS.csv\n")
```


```{r}
# NGFS Data and Validation
ngfs <- readRDS("data/NGFS_scenario_data_publication.rds")  # scenario data
hist_ngfs <- readRDS("data/NGFS_reference_data_publication.rds")  # reference data

# model harmonization 
model_matching <- c(
  "GCAM 6.0 NGFS" = "GCAM",
  "MESSAGEix-GLOBIOM 2.0-M-R12-NGFS" = "MESSAGE",
  "REMIND-MAgPIE 3.3-4.8" = "REMIND"
)
ngfs <- quitte::revalue.levels(ngfs, model = model_matching)

# variables harmonization
vars_matching <- c(
  "Carbon Sequestration|CCS" = "Carbon Capture|Geological Storage")
ngfs <- quitte::revalue.levels(ngfs, variable = vars_matching)

# scenarios harmonization
scen_matching <- c(
  "Nationally Determined Contributions (NDCs)" = "NDCs",
  "Below 2Â°C" = "Below 2C")
ngfs <- quitte::revalue.levels(ngfs, scenario = scen_matching)

# perform validation
df_ngfs <- validateScenarios(rbind(ngfs, hist_ngfs), config = "publication_NGFS")
df_ngfs <- appendTooltips(df_ngfs)
```


## Plots

```{r}
# shorten variable names for better plots
vars.short <- c(
  "Capacity|Electricity|Hydro" = "Cap|Hydro",
  "Capacity|Electricity|Solar" = "Cap|Solar",
  "Capacity|Electricity|Wind"  = "Cap|Wind",
  "Emissions|CO2" = "Emi|CO2"
)

df_ngfs <-   quitte::revalue.levels(df_ngfs, variable = vars.short)
hist_ngfs <- quitte::revalue.levels(hist_ngfs, variable = vars.short)
ngfs <-      quitte::revalue.levels(ngfs, variable = vars.short)
```

### Overview

Overview for historical and near-term validation of multiple variables.

```{r}
d <- df_ngfs %>% 
  filter(period <= 2030, 
         variable %in% c("Cap|Hydro", "Cap|Wind", "Cap|Solar"))
validationHeatmap(d, 
                  main_dim = "region",
                  interactive = FALSE,
                  x_plot = "period",
                  y_plot = "scenario",
                  x_facet = "variable",
                  y_facet = "model")

# closer look at wind
linePlotThresholds(df_ngfs %>% filter(variable == "Cap|Wind"), 
                   scenData = ngfs,
                   refData = hist_ngfs %>% filter(model == "Ember"),
                   xlim = c(2015, 2030),
                   interactive = FALSE)
```

###  Model intercomparison - relative

Relative to MESSAGEix-GLOBIOM.

```{r}
# are GCAM or REMIND higher/lower than MESSAGE?
d <- df_ngfs %>% filter(ref_model == "MESSAGE")

# relative deviations
validationHeatmap(d %>% filter(period <= "2060", metric == "relative"),
                  interactive = FALSE, 
                  main_dim = "region",
                  x_plot = "period",
                  y_plot = "scenario",
                  x_facet = "variable",
                  y_facet = "model")

linePlotThresholds(d %>% filter(scenario == "Delayed transition", metric == "relative"), 
                   scenData = ngfs %>% filter(scenario == "Delayed transition"), 
                   xlim = c(2020, 2060),
                   interactive = FALSE)
```

###  Model intercomparison - difference

```{r}
# absolute deviations
validationHeatmap(d %>% filter(period <= "2060", metric == "difference"),
                  interactive = FALSE, 
                  main_dim = "region",
                  x_plot = "period",
                  y_plot = "scenario",
                  x_facet = "variable",
                  y_facet = "model")

linePlotThresholds(d %>% filter(scenario == "Delayed transition", metric == "difference"), 
                   scenData = ngfs %>% filter(scenario == "Delayed transition"), 
                   xlim = c(2020, 2060),
                   interactive = FALSE)
```

### Scenario intercomparison

Relative to the "Below 2C" scenario.

```{r}
# are scenarios higher/lower than the "Below 2C" scenario?
d <- df_ngfs %>% filter(ref_scenario == "Below 2C")

# absolute deviations
validationHeatmap(d %>% filter(period <= "2050", metric == "difference"),
                  interactive = FALSE, 
                  main_dim = "region",
                  x_plot = "period",
                  y_plot = "scenario",
                  x_facet = "variable",
                  y_facet = "model")

linePlotThresholds(d %>% filter(model == "REMIND", metric == "difference"), 
                   scenData = ngfs %>% filter(model == "REMIND"), 
                   xlim = c(2020, 2050),
                   interactive = FALSE)
```

### Period intercomparison

Relative to 2020.

```{r}
# how are 2025-2035 values compared to 2020?
d <- df_ngfs %>% filter(ref_period == "2020")

validationHeatmap(d %>% filter(period <= "2040", metric == "relative"),
                   interactive = FALSE,
                  main_dim = "region",
                  x_plot = "period",
                  y_plot = "scenario",
                  x_facet = "variable",
                  y_facet = "model")

linePlotThresholds(d %>% filter(scenario == "Delayed transition", 
                                metric == "relative",
                                model == "REMIND"), 
                   scenData = ngfs %>% filter(model == "REMIND"), 
                   xlim = c(2020, 2040),
                   interactive = FALSE)
```
